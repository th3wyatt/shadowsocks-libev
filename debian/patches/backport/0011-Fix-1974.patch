From: Max Lv <max.c.lv@gmail.com>
Date: Mon, 12 Mar 2018 02:53:58 -0700
Subject: Fix #1974

(cherry picked from commit a377c5114a7a0786e2443dfa53187effacce1af5)
---
 src/local.c  | 9 ++++++---
 src/redir.c  | 7 +++++--
 src/server.c | 7 +++++--
 src/tunnel.c | 7 +++++--
 4 files changed, 21 insertions(+), 9 deletions(-)

diff --git a/src/local.c b/src/local.c
index b116461..b856d83 100644
--- a/src/local.c
+++ b/src/local.c
@@ -101,6 +101,7 @@ static int ipv6first = 0;
 static int fast_open = 0;
 static int no_delay  = 0;
 static int udp_fd    = 0;
+static int ret_val   = 0;
 
 static struct ev_signal sigint_watcher;
 static struct ev_signal sigterm_watcher;
@@ -1214,8 +1215,10 @@ signal_cb(EV_P_ ev_signal *w, int revents)
     if (revents & EV_SIGNAL) {
         switch (w->signum) {
         case SIGCHLD:
-            if (!is_plugin_running())
+            if (!is_plugin_running()) {
                 LOGE("plugin service exit unexpectedly");
+                ret_val = -1;
+            }
             else
                 return;
         case SIGUSR1:
@@ -1711,7 +1714,7 @@ main(int argc, char **argv)
         free_udprelay();
     }
 
-    return 0;
+    return ret_val;
 }
 
 #else
@@ -1848,7 +1851,7 @@ _start_ss_local_server(profile_t profile, ss_local_callback callback, void *udat
         free_udprelay();
     }
 
-    return 0;
+    return ret_val;
 }
 
 int
diff --git a/src/redir.c b/src/redir.c
index e748aa8..2d631e5 100644
--- a/src/redir.c
+++ b/src/redir.c
@@ -96,6 +96,7 @@ static int nofile = 0;
 #endif
 static int fast_open = 0;
 static int no_delay  = 0;
+static int ret_val   = 0;
 
 static struct ev_signal sigint_watcher;
 static struct ev_signal sigterm_watcher;
@@ -819,8 +820,10 @@ signal_cb(EV_P_ ev_signal *w, int revents)
     if (revents & EV_SIGNAL) {
         switch (w->signum) {
         case SIGCHLD:
-            if (!is_plugin_running())
+            if (!is_plugin_running()) {
                 LOGE("plugin service exit unexpectedly");
+                ret_val = -1;
+            }
             else
                 return;
         case SIGINT:
@@ -1258,5 +1261,5 @@ main(int argc, char **argv)
         stop_plugin();
     }
 
-    return 0;
+    return ret_val;
 }
diff --git a/src/server.c b/src/server.c
index b5f7854..c01fb08 100644
--- a/src/server.c
+++ b/src/server.c
@@ -120,6 +120,7 @@ static int mode      = TCP_ONLY;
 static int ipv6first = 0;
 static int fast_open = 0;
 static int no_delay  = 0;
+static int ret_val   = 0;
 
 #ifdef HAVE_SETRLIMIT
 static int nofile = 0;
@@ -1409,8 +1410,10 @@ signal_cb(EV_P_ ev_signal *w, int revents)
     if (revents & EV_SIGNAL) {
         switch (w->signum) {
         case SIGCHLD:
-            if (!is_plugin_running())
+            if (!is_plugin_running()) {
                 LOGE("plugin service exit unexpectedly");
+                ret_val = -1;
+            }
             else
                 return;
         case SIGINT:
@@ -1949,5 +1952,5 @@ main(int argc, char **argv)
         free_udprelay();
     }
 
-    return 0;
+    return ret_val;
 }
diff --git a/src/tunnel.c b/src/tunnel.c
index ddc1039..e5707a3 100644
--- a/src/tunnel.c
+++ b/src/tunnel.c
@@ -95,6 +95,7 @@ static int mode      = TCP_ONLY;
 static int nofile = 0;
 #endif
 static int no_delay = 0;
+static int ret_val  = 0;
 
 static struct ev_signal sigint_watcher;
 static struct ev_signal sigterm_watcher;
@@ -739,8 +740,10 @@ signal_cb(EV_P_ ev_signal *w, int revents)
     if (revents & EV_SIGNAL) {
         switch (w->signum) {
         case SIGCHLD:
-            if (!is_plugin_running())
+            if (!is_plugin_running()) {
                 LOGE("plugin service exit unexpectedly");
+                ret_val = -1;
+            }
             else
                 return;
         case SIGINT:
@@ -1164,5 +1167,5 @@ main(int argc, char **argv)
         stop_plugin();
     }
 
-    return 0;
+    return ret_val;
 }
