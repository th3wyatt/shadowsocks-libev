From: Max Lv <max.c.lv@gmail.com>
Date: Fri, 19 Oct 2018 09:01:39 +0800
Subject: Add check for reusing server's nonce/salt

(cherry picked from commit 92cab3503c94b36234872f66926de0070a9cdcd0)
---
 src/aead.c   | 4 ++++
 src/stream.c | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/src/aead.c b/src/aead.c
index 9e2da72..49540c3 100644
--- a/src/aead.c
+++ b/src/aead.c
@@ -373,6 +373,8 @@ aead_encrypt_all(buffer_t *plaintext, cipher_t *cipher, size_t capacity)
     /* copy salt to first pos */
     memcpy(ciphertext->data, cipher_ctx.salt, salt_len);
 
+    ppbloom_add((void *)cipher_ctx.salt, salt_len);
+
     aead_cipher_ctx_set_key(&cipher_ctx, 1);
 
     size_t clen = ciphertext->len;
@@ -517,6 +519,8 @@ aead_encrypt(buffer_t *plaintext, cipher_ctx_t *cipher_ctx, size_t capacity)
         memcpy(ciphertext->data, cipher_ctx->salt, salt_len);
         aead_cipher_ctx_set_key(cipher_ctx, 1);
         cipher_ctx->init = 1;
+
+        ppbloom_add((void *)cipher_ctx->salt, salt_len);
     }
 
     err = aead_chunk_encrypt(cipher_ctx,
diff --git a/src/stream.c b/src/stream.c
index 3817dbb..0556c38 100644
--- a/src/stream.c
+++ b/src/stream.c
@@ -345,6 +345,8 @@ stream_encrypt_all(buffer_t *plaintext, cipher_t *cipher, size_t capacity)
     cipher_ctx_set_nonce(&cipher_ctx, nonce, nonce_len, 1);
     memcpy(ciphertext->data, nonce, nonce_len);
 
+    ppbloom_add((void *)nonce, nonce_len);
+
     if (cipher->method >= SALSA20) {
         crypto_stream_xor_ic((uint8_t *)(ciphertext->data + nonce_len),
                              (const uint8_t *)plaintext->data, (uint64_t)(plaintext->len),
@@ -399,6 +401,8 @@ stream_encrypt(buffer_t *plaintext, cipher_ctx_t *cipher_ctx, size_t capacity)
         memcpy(ciphertext->data, cipher_ctx->nonce, nonce_len);
         cipher_ctx->counter = 0;
         cipher_ctx->init    = 1;
+
+        ppbloom_add((void *)cipher_ctx->nonce, nonce_len);
     }
 
     if (cipher->method >= SALSA20) {
