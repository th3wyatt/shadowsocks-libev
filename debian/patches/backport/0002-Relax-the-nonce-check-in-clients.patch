From: Max Lv <max.c.lv@gmail.com>
Date: Tue, 13 Nov 2018 23:09:05 +0800
Subject: Relax the nonce check in clients

(cherry picked from commit 519776cee499ec66525e3063f0e97d4300c0f509)
---
 src/stream.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/src/stream.c b/src/stream.c
index 0556c38..85e8282 100644
--- a/src/stream.c
+++ b/src/stream.c
@@ -345,7 +345,9 @@ stream_encrypt_all(buffer_t *plaintext, cipher_t *cipher, size_t capacity)
     cipher_ctx_set_nonce(&cipher_ctx, nonce, nonce_len, 1);
     memcpy(ciphertext->data, nonce, nonce_len);
 
+#ifdef MODULE_REMOTE
     ppbloom_add((void *)nonce, nonce_len);
+#endif
 
     if (cipher->method >= SALSA20) {
         crypto_stream_xor_ic((uint8_t *)(ciphertext->data + nonce_len),
@@ -402,7 +404,9 @@ stream_encrypt(buffer_t *plaintext, cipher_ctx_t *cipher_ctx, size_t capacity)
         cipher_ctx->counter = 0;
         cipher_ctx->init    = 1;
 
+#ifdef MODULE_REMOTE
         ppbloom_add((void *)cipher_ctx->nonce, nonce_len);
+#endif
     }
 
     if (cipher->method >= SALSA20) {
